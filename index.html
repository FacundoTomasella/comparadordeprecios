<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comparador de Precios</title>
    
    <!-- Fuente Google (Inter) para look moderno -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --green-price: #16a34a;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text-main); padding-bottom: 40px; }

        /* HEADER & SEARCH */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .app-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; color: var(--primary); }
        
        .search-container { position: relative; max-width: 800px; margin: 0 auto; }
        
        #searchInput {
            width: 100%; padding: 12px 20px 12px 45px;
            border-radius: 12px; border: 1px solid #cbd5e1;
            background: #f1f5f9; font-size: 16px; outline: none; transition: 0.3s;
        }
        
        #searchInput:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* CATEGORY CHIPS */
        .categories-wrapper {
            overflow-x: auto; white-space: nowrap; padding: 15px 20px;
            background: var(--bg); -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border);
        }
        
        .chip {
            display: inline-block; padding: 8px 16px; margin-right: 8px;
            background: #fff; border: 1px solid var(--border);
            border-radius: 20px; font-size: 14px; font-weight: 600;
            color: var(--text-sec); cursor: pointer; transition: 0.2s;
        }
        
        .chip.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }

        /* PRODUCT LIST */
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--card-bg); border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden; border: 1px solid var(--border);
            transition: transform 0.2s;
            display: flex; flex-direction: column;
        }

        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .card-header { padding: 15px; border-bottom: 1px solid #f1f5f9; background: #fafafa; }
        .product-name { font-size: 1.1rem; font-weight: 700; line-height: 1.4; }
        .product-category { font-size: 0.8rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        .best-price-banner {
            background: #dcfce7; color: #166534;
            padding: 8px 15px; font-weight: 700; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        .price-list { padding: 10px 15px; flex-grow: 1; }
        
        .price-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.95rem;
        }
        
        .price-row:last-child { border-bottom: none; }
        
        .store-name { color: var(--text-sec); font-weight: 500; }
        .store-price { font-weight: 600; color: var(--text-main); }
        
        .store-price.winner { color: var(--green-price); font-weight: 800; }
        .store-price.no-stock { color: #ef4444; font-size: 0.85rem; font-weight: 400; }

        /* LOADING */
        .loader { text-align: center; padding: 40px; color: var(--text-sec); font-size: 1.2rem; }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .card { border-radius: 12px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-container">
            <div class="app-title">üõí Comparador de Precios</div>
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Buscar producto (ej: Caf√©, Arroz, Leche)...">
        </div>
    </div>

    <div class="categories-wrapper" id="categoryContainer">
        <span class="chip active" onclick="filterCategory('Todo')">Todo</span>
        <!-- Categor√≠as se llenan con JS -->
    </div>

    <div class="container">
        <div id="loader" class="loader">Cargando precios actualizados... ‚è≥</div>
        <div class="grid" id="productGrid">
            <!-- Productos se llenan con JS -->
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN: URL DEL CSV DE GOOGLE SHEETS
        const SHEET_ID = '1159450908'; // El GID de tu hoja "LISTADO" (o donde est√©n los datos finales)
        const SPREADSHEET_KEY = '2PACX-1vR6UTln-nhhZCArBfy7FzU2CO1jel87qmlBquCFWYDmson-uoJeD_Q22K5Yiq6l48rZF71cjhERzAZf';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SPREADSHEET_KEY}/pub?gid=${SHEET_ID}&single=true&output=csv`;

        let allProducts = [];
        let categories = new Set();

        // 1. INICIAR APP
        async function initApp() {
            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                const rows = parseCSV(data);
                
                // Procesar filas (Asumiendo que la fila 1 son encabezados)
                // Estructura esperada por √≠ndices seg√∫n tu hoja:
                // 0: Producto, 1: Categoria, 2: CotoURL ... 
                // NECESITAMOS LOS PRECIOS. 
                // En tu script de Apps Script, los precios se guardan en:
                // F(5): Coto, G(6): Carr, H(7): Dia, I(8): Jumbo, K(10): Alternativa
                
                // AJUSTE: Si usas IMPORTRANGE para crear la hoja "LISTADO" para la web,
                // aseg√∫rate que las columnas sean limpias.
                // Aqu√≠ asumir√© que la hoja "LISTADO" tiene:
                // A: Producto, B: Categoria, C: Precio Coto, D: Precio Carr, E: Precio Dia, F: Precio Jumbo, G: Precio Alt
                
                // Si lees directo de la hoja "Productos" donde corre el script:
                // A(0): Nombre
                // G(6): Categoria (seg√∫n tu imagen estaba en la B, pero ajustaremos din√°micamente)
                // F(5): $ Coto
                // G(6): $ Carr
                // H(7): $ Dia
                // I(8): $ Jumbo
                // K(10): $ Alt
                
                // VAMOS A USAR NOMBRES DE COLUMNAS PARA SER M√ÅS SEGUROS
                const headers = rows[0].map(h => h.toLowerCase().trim());
                
                // Mapear √≠ndices
                const idxName = 0; // Columna A siempre es nombre
                const idxCat = headers.indexOf('categoria') > -1 ? headers.indexOf('categoria') : 1; // Buscar columna categoria
                
                // Buscamos columnas de precios (ajusta estos nombres seg√∫n tu cabecera real en la hoja)
                // OJO: En tu imagen se ve√≠an columnas ocultas.
                // Voy a usar √≠ndices fijos basados en tu script anterior:
                // F=5, G=6, H=7, I=8, K=10.
                
                allProducts = rows.slice(1).map(row => {
                    if (!row[0]) return null;

                    // Extraer precios y limpiar s√≠mbolos
                    const prices = [
                        { name: 'Coto', price: cleanPrice(row[5]) },      // Columna F
                        { name: 'Carrefour', price: cleanPrice(row[6]) }, // Columna G
                        { name: 'D√≠a', price: cleanPrice(row[7]) },       // Columna H
                        { name: 'Jumbo', price: cleanPrice(row[8]) },     // Columna I
                        { name: 'Otro', price: cleanPrice(row[10]) }      // Columna K
                    ];

                    // Filtrar precios v√°lidos para encontrar el mejor
                    const validPrices = prices.filter(p => p.price > 0);
                    validPrices.sort((a, b) => a.price - b.price);
                    
                    const bestOption = validPrices.length > 0 ? validPrices[0] : null;

                    // Guardar categor√≠a
                    const cat = row[1] || 'Varios'; // Asumiendo Col B es categoria (ajustar si es necesario)
                    if(cat) categories.add(cat);

                    return {
                        name: row[0],
                        category: cat,
                        prices: prices,
                        bestOption: bestOption
                    };
                }).filter(p => p !== null);

                renderCategories();
                renderProducts(allProducts);
                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerHTML = "Error cargando datos. <br> Verifica que la hoja est√© publicada como CSV.";
            }
        }

        // 2. PARSEAR CSV (Maneja comillas y comas)
        function parseCSV(str) {
            const arr = [];
            let quote = false;  // 'true' means we're inside a quoted field
            let col = 0, c = 0;
            for (let r = 0; r < str.length; r++) {
                let char = str[r], next = str[r+1];
                if (!arr[col]) arr[col] = [];
                if (!arr[col][c]) arr[col][c] = "";
                
                if (char === '"') {
                    if (quote && next === '"') { arr[col][c] += '"'; r++; }
                    else { quote = !quote; }
                } else if (char === ',' && !quote) {
                    c++;
                } else if ((char === '\r' || char === '\n') && !quote) {
                    if (arr[col][c] || c>0) { col++; c = 0; } // New row
                    if (char === '\r' && next === '\n') r++;
                } else {
                    arr[col][c] += char;
                }
            }
            return arr;
        }

        // 3. LIMPIAR PRECIO (De "$ 1.200,00" a 1200.00)
        function cleanPrice(priceStr) {
            if (!priceStr) return 0;
            // Si dice "Sin Stock" o error
            if (priceStr.toLowerCase().includes('sin') || priceStr.toLowerCase().includes('error')) return 0;
            
            // Quitar $ y puntos de mil, cambiar coma decimal por punto
            // Ejemplo: "$ 1.250,50" -> "1250.50"
            let clean = priceStr.toString().replace(/[$.]/g, '').replace(',', '.').trim();
            return parseFloat(clean) || 0;
        }

        // 4. FORMATO MONEDA
        const formatter = new Intl.NumberFormat('es-AR', {
            style: 'currency',
            currency: 'ARS',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        // 5. RENDERIZAR CATEGOR√çAS
        function renderCategories() {
            const container = document.getElementById('categoryContainer');
            const sortedCats = Array.from(categories).sort();
            
            sortedCats.forEach(cat => {
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.textContent = cat;
                chip.onclick = () => {
                    // Manejo de clases active
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterCategory(cat);
                };
                container.appendChild(chip);
            });
        }

        // 6. RENDERIZAR PRODUCTOS
        function renderProducts(products) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666;">No se encontraron productos.</div>';
                return;
            }

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';

                // Generar HTML de precios
                let pricesHtml = '';
                p.prices.forEach(priceObj => {
                    let priceClass = 'store-price';
                    let priceText = '';
                    
                    if (priceObj.price === 0) {
                        priceClass += ' no-stock';
                        priceText = 'Sin Stock';
                    } else {
                        priceText = formatter.format(priceObj.price);
                        // Si es el mejor precio y hay stock
                        if (p.bestOption && priceObj.price === p.bestOption.price) {
                            priceClass += ' winner';
                        }
                    }

                    pricesHtml += `
                        <div class="price-row">
                            <span class="store-name">${priceObj.name}</span>
                            <span class="${priceClass}">${priceText}</span>
                        </div>
                    `;
                });

                let bestPriceBadge = '';
                if (p.bestOption) {
                    bestPriceBadge = `
                        <div class="best-price-banner">
                            <span>Mejor precio:</span>
                            <span>${formatter.format(p.bestOption.price)} (${p.bestOption.name})</span>
                        </div>
                    `;
                } else {
                    bestPriceBadge = `
                        <div class="best-price-banner" style="background: #fecaca; color: #991b1b;">
                            <span>Sin Stock Disponible</span>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div class="product-name">${p.name}</div>
                        <div class="product-category">${p.category}</div>
                    </div>
                    ${bestPriceBadge}
                    <div class="price-list">
                        ${pricesHtml}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 7. FILTROS
        function filterCategory(cat) {
            const term = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allProducts;

            if (cat !== 'Todo') {
                filtered = filtered.filter(p => p.category === cat);
            }
            
            if (term) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(term));
            }
            
            renderProducts(filtered);
        }

        // Buscador en tiempo real
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const activeChip = document.querySelector('.chip.active');
            const currentCat = activeChip ? activeChip.textContent : 'Todo';
            filterCategory(currentCat);
        });

        // INICIAR
        initApp();

    </script>
</body>
</html>
