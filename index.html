<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Comparador de Precios</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --bg: #f3f4f6; --text: #1f2937; --border: #e5e7eb; --header-bg: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 30px; }

        /* HEADER */
        header {
            background: var(--header-bg); padding: 15px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #064e3b; }
        
        /* SEARCH */
        #searchInput {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;
            background: #f9fafb; font-size: 16px; outline: none;
        }

        /* CATEGORY TABS */
        .tabs-container {
            overflow-x: auto; white-space: nowrap; padding: 10px 15px;
            background: var(--bg); -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border);
        }
        .tab-btn {
            display: inline-block; padding: 8px 16px; margin-right: 8px;
            background: #fff; border: 1px solid #d1d5db; border-radius: 20px;
            font-size: 14px; font-weight: 600; color: #4b5563; cursor: pointer;
            transition: 0.2s; user-select: none;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* TABLE CONTAINER */
        .table-wrapper {
            margin: 15px; background: white; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
            border: 1px solid var(--border);
            position: relative;
        }
        
        /* TABLE STYLES */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; /* Force scroll on mobile */ }
        
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        th { background: #f9fafb; font-weight: 600; color: #374151; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        
        /* Sticky First Column (Product Name) */
        th:first-child, td:first-child {
            position: sticky; left: 0; z-index: 10;
            background: white; text-align: left; font-weight: 700;
            border-right: 2px solid #f3f4f6;
            min-width: 140px; max-width: 180px;
        }
        th:first-child { background: #f9fafb; z-index: 20; }

        /* Prices */
        .price-cell { font-family: monospace; font-size: 15px; color: #4b5563; }
        .best-price { background-color: #d1fae5; color: #047857; font-weight: 800; border-radius: 6px; padding: 4px 8px; }
        .no-stock { color: #ef4444; font-size: 12px; font-style: italic; }

        /* Loader */
        #loader { text-align: center; padding: 40px; color: #6b7280; }
        
        /* Link styles */
        a.product-link { text-decoration: none; color: inherit; }
    </style>
</head>
<body>

    <header>
        <h1>üõí Comparador Precios</h1>
        <input type="text" id="searchInput" placeholder="Buscar producto...">
    </header>

    <div class="tabs-container" id="tabsContainer">
        <!-- Los botones se generan aqu√≠ -->
    </div>

    <div id="loader">Cargando datos...</div>

    <div class="table-wrapper">
        <div class="table-scroll">
            <table id="priceTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN IMPORTANTE
        // ==========================================
        // Tu ID de hoja general (Key)
        const SHEET_KEY = '2PACX-1vR6UTln-nhhZCArBfy7FzU2CO1jel87qmlBquCFWYDmson-uoJeD_Q22K5Yiq6l48rZF71cjhERzAZf';
        
        // AQU√ç DEBES PONER LOS GID DE CADA PESTA√ëA
        // Si no sabes el GID, ve a tu hoja, entra a la pesta√±a y mira la URL (gid=XXXX)
        const CATEGORIAS = [
            { name: "Carnicer√≠a", gid: "1159450908" }, // Reemplaza con el GID real de Carniceria
            { name: "Verduler√≠a", gid: "0" },          // Reemplaza con el GID real
            { name: "Almac√©n", gid: "123456" },        // Reemplaza...
            { name: "Diet√©tica", gid: "789012" },      // Reemplaza...
            { name: "Mascotas", gid: "345678" }        // Reemplaza...
        ];

        let currentData = [];

        // 1. Inicializar
        async function init() {
            renderTabs();
            // Cargamos la primera categor√≠a por defecto
            await loadCategory(CATEGORIAS[0]);
        }

        // 2. Crear Botones de Categor√≠a
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';
            CATEGORIAS.forEach((cat, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                btn.innerText = cat.name;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadCategory(cat);
                };
                container.appendChild(btn);
            });
        }

        // 3. Cargar Datos de la Hoja Seleccionada
        async function loadCategory(category) {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('tableHead').innerHTML = '';
            document.getElementById('tableBody').innerHTML = '';
            
            // Construir URL del CSV espec√≠fico de esa pesta√±a (GID)
            const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_KEY}/pub?gid=${category.gid}&single=true&output=csv`;

            try {
                const response = await fetch(url);
                const csvText = await response.text();
                const rows = parseCSV(csvText);

                if (rows.length < 2) {
                    document.getElementById('loader').innerText = "Hoja vac√≠a o error de GID";
                    return;
                }

                // PROCESAR ENCABEZADOS (Fila 0)
                // Asumimos estructura: A=Producto, B,C,D,E... = Tiendas con Links (ignoramos), F,G,H... = Precios
                // PERO, para hacerlo din√°mico seg√∫n tu imagen, vamos a detectar columnas de PRECIOS.
                
                // Tu imagen muestra: Producto | Coto | Carrefour | Dia | Jumbo | Res | Ganador
                // El script necesita saber cu√°les columnas son precios para compararlos.
                // Asumiremos que desde la columna 1 hasta la ante√∫ltima son tiendas.
                
                const headers = rows[0]; 
                
                // Identificar √≠ndices
                // Asumimos: Col 0 es Nombre.
                // Buscamos columnas que parezcan precios o tiendas.
                // Para simplificar: En tu hoja de Carniceria, Col B,C,D,E,F son links? O son los precios ya?
                // Seg√∫n tu script anterior, los precios se escriben en F, G, H, I, K.
                
                // ESTRATEGIA VISUAL: Vamos a renderizar las columnas que tengan precios.
                // En tu hoja final (la de la imagen), ya tienes los precios "limpios" en un rango continuo?
                // Si la imagen que me pasaste es la hoja final:
                // Col A: Producto
                // Col B: Coto ($)
                // Col C: Carrefour ($)
                // ...
                
                // Renderizar Tabla
                renderTable(headers, rows.slice(1));
                
            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerText = "Error de conexi√≥n";
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // 4. Renderizar Tabla con L√≥gica de Precios
        function renderTable(headers, data) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            currentData = data; // Guardamos para el buscador

            // Generar Encabezados
            // Ocultamos columnas irrelevantes si las hubiera (ej: links crudos)
            // Mostraremos: Producto y las columnas siguientes que sean tiendas.
            
            // Definimos qu√© columnas mostrar. Asumimos:
            // 0 = Producto (Fijo)
            // 5, 6, 7, 8, 10 = Son las columnas donde tu script escribe precios (F, G, H, I, K)
            // Si has reorganizado la hoja para que se vea como la foto, ajusta estos √≠ndices.
            // SI LA HOJA YA SE VE COMO LA FOTO:
            // Usamos todas las columnas visibles.
            
            // Voy a asumir que en la hoja "P√∫blica" (la que ve la web) ya ordenaste las columnas para que queden juntas.
            // Si no, usaremos los indices del script: 5,6,7,8,10
            
            let rowHtml = '<tr>';
            // Encabezado Producto
            rowHtml += `<th>${headers[0]}</th>`;
            
            // Encabezados Tiendas (Indices 5,6,7,8,10 basados en tu script anterior)
            // Si la hoja ya est√° ordenada (A=Prod, B=Coto, C=Carr...), usa indices 1,2,3...
            // VOY A USAR L√ìGICA DIN√ÅMICA: Si la celda contiene "$", es precio.
            
            // Para este ejemplo, usar√© los √≠ndices donde tu script escrib√≠a los precios: F(5), G(6), H(7), I(8), K(10)
            const priceIndices = [5, 6, 7, 8, 10]; 
            
            priceIndices.forEach(idx => {
                if (headers[idx]) rowHtml += `<th>${headers[idx]}</th>`;
            });
            rowHtml += '</tr>';
            thead.innerHTML = rowHtml;

            // Generar Cuerpo
            renderRows(data, priceIndices);
        }

        function renderRows(rows, priceIndices) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                if (!row[0]) return; // Fila vac√≠a

                const tr = document.createElement('tr');
                
                // 1. Nombre Producto
                let html = `<td>${row[0]}</td>`;

                // 2. Calcular mejor precio de esta fila
                let minPrice = Infinity;
                
                // Primero extraemos valores num√©ricos
                const prices = {};
                priceIndices.forEach(idx => {
                    const rawVal = row[idx];
                    const cleanVal = parsePrice(rawVal);
                    prices[idx] = cleanVal;
                    if (cleanVal > 0 && cleanVal < minPrice) {
                        minPrice = cleanVal;
                    }
                });

                // 3. Generar celdas de precios
                priceIndices.forEach(idx => {
                    if (!row[idx]) { // Si la columna no existe en esta fila
                         html += `<td>-</td>`;
                         return;
                    }

                    const val = prices[idx];
                    const text = row[idx];
                    let cellClass = "price-cell";
                    
                    if (val === 0) {
                        html += `<td class="no-stock">Sin Stock</td>`;
                    } else {
                        // Si es el m√≠nimo, agregamos clase winner
                        if (val === minPrice) {
                            html += `<td><span class="best-price">$${formatNumber(val)}</span></td>`;
                        } else {
                            html += `<td class="price-cell">$${formatNumber(val)}</td>`;
                        }
                    }
                });

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        // --- UTILIDADES ---

        // Buscador
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const txt = row.cells[0].textContent.toLowerCase();
                row.style.display = txt.includes(term) ? '' : 'none';
            });
        });

        // Parseador CSV robusto
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let col = 0, c = 0;
            for (let r = 0; r < str.length; r++) {
                let char = str[r], next = str[r+1];
                if (!arr[col]) arr[col] = [];
                if (!arr[col][c]) arr[col][c] = "";
                if (char === '"') {
                    if (quote && next === '"') { arr[col][c] += '"'; r++; }
                    else { quote = !quote; }
                } else if (char === ',' && !quote) { c++; }
                else if ((char === '\r' || char === '\n') && !quote) {
                    if (arr[col][c] || c>0) { col++; c = 0; }
                    if (char === '\r' && next === '\n') r++;
                } else { arr[col][c] += char; }
            }
            return arr;
        }

        // Limpiador de precios Argentinos ($ 1.200,50 -> 1200.50)
        function parsePrice(str) {
            if (!str) return 0;
            if (str.toLowerCase().includes('sin') || str.toLowerCase().includes('error')) return 0;
            // Quitamos $ y puntos, cambiamos coma por punto
            let clean = str.toString().replace(/[$.]/g, '').replace(',', '.').trim();
            return parseFloat(clean) || 0;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0 }).format(num);
        }

        // Arrancar
        init();
    </script>
</body>
</html>

